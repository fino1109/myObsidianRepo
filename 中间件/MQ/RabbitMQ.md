# 相关概念

## 消息中间件

## 服务端

### 交换机

#### 类型

-   fanout：消息发送到所有的绑定队列中
-   direct：消息分发到路由键完全匹配的队列

-   topic：路由键可条件匹配
-   headers：部根据路由键进行匹配 根据headers属性进行队列匹配

#### 持久化

#### 是否自动删除

自动删除的前提是至少有个队列或者交换机与该交换机绑定，之后所有的队列或交换机都解绑后才会执行自动删除。

#### 是否内置

客户端程序无法直接发送消息到这个交换机中，只能通过交换机路由到交换机这种方式。

#### 参数

#### 路由键

### 队列

#### 属性

-   名称
-   是否持久化

-   是否排他

-   如果一个队列设置为排他，则该队列仅对首次声明它的连接可见，并在断开时删除。

-   是否自动删除

-   特性与交换机的自动删除类似

-   注意MQ的消息存在队列中，交换机的使用并不消耗性能二队列会
-   过期时间

-   消息的ttl：

-   每个消息设置单独的过期时间
-   ttl=0 除非可以直接消费否则立刻抛弃 3.0版本后用immediate参数代替 可用死信队列实现

-   不设置ttl 不过期
-   设置ttl

-   消息一旦过期马上被抛弃
-   消息过期时不马上抛弃 而是在消费时判断

-   队列的ttl：队列中所有消息过期时间相同
-   消息过期：变成死信 消费者无法再接收消息

#### 死信队列

DLX 全称：DEAD LETTER EXCHANGE 可以称为死信交换器，当一个消息在队列中变成死信后，可以重新被投递到另一个交换机中，这个交换机就是dlx，与dlx交换机绑定的队列被称为死信队列。

消息被投递到死信队列的情况：

-   消息被拒绝并且设置requeue参数为false
-   消息过期

-   队列达到最大长度

当这个队列中存在死信时，MQ会自动的将消息发送到设置的dlx，进而被路由到死信队列，可以监听这个队列中的消息并进行处理。

DLX是个非常有用的特性，它可以处理异常下不能被正常消费的消息，后续分析程序可以通过分析死信队列中的数据来分析当时遇到的异常情况，进而优化和改善系统。

#### 延迟队列

延迟队列存储的对象时对应的延迟消息，也就是消息被发送后不打算被消费者立即消费的消息，而是等待特定事件后再进行消费。

#### 优先级队列

具有高优先级的队列具有高优先权，可以优先被消费者消费，可以设置队列的max priority来实现。

### 持久化

-   交换机持久化：持久化交换机的元数据保证重启不丢失
-   队列持久化：保证队列的元数据重启不丢失 如果非持久化 消息也将丢失

-   消息持久化：队列持久化仅保证队列元数据不丢失，消息持久化才能保证消息不丢失
-   总结：全部消息持久化会严重影响MQ的性能，在选择消息是否持久化时，需要在可靠性和吞吐量之间做一个权衡。

## 生产者

### 发送消息

-   mandatory：

-   true交换机无法根据自身类型和路由键找到相符队列则将消息返还给生产者
-   false上述情况会直接抛弃消息

-   immediate：

-   true队列不存在消费者则返还给生产者
-   false直接抛弃

### 生产者确认

#### 事务

开销巨大 不建议使用

事务机制在一条消息发送后会使发送端阻塞

#### 发送方确认机制

-   生产者将信道设置成confirm模式，信道上的消息都会被指派以为唯一的idc开始，一旦消息被投递到匹配的队列，rabbitmq会发消息给生产者ack，如果消息是持久化的则会在落盘后发送。
-   优点：异步，可在等待返回的同时发布下一条消息，确认为ack，丢失为nack。

-   注意：

-   事务和发送方确认机制互斥，不能共存
-   上述两种方式只保证消息发送到交换机，如果没有匹配队列消息也会丢失

-   两种方法：

-   批量confirm：发送一批消息后调用方法等待服务器确认返回
-   异步confirm：提供一个回调方法，服务端确认了一条或者多条消息后客户端回调该方法进行处理

## 消费者

### 消费模式

-   推模式：接收消息一般通过实现Consumer接口或继承DefaultConsumer类来实现

-   quereName：队列名
-   autoAck：是否自动确认

-   consumerTag：消费者标签（用于区分多个消费者者）
-   noLocal：不能将同一个连接中的生产者的消息发送给这个链接中的消费者

-   exclusive：是否排他
-   arguments：其他参数

-   callback设置回调函数，用于处理MQ推送的消息

-   拉模式：通过channel.basicGet()方法获取消息

### 消费端拒绝与确认

basic.reject()一次只能拒绝一条消息

basic.nack()批量拒绝

### 消息分发

-   轮询
-   basicQos

### 消息顺序性

无法保证 需要客户端跟进处理

### 弃用queueingconsumer

### MQ无法去重

## amqp协议

### 定义

### 分层

-   module layer：

-   位于协议最高层，定义了供客户端调用的命令

-   session layer：

-   位于中间层，主要负责将客户端的命令发送给服务器，再将服务端的应答发送给客户端

-   transport layer：

-   位于底层，主要传输二进制数据流 提供帧处理，信道复用错误检测和数据表示

# 管理

# 高可用